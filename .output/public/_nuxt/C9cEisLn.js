import{D as d}from"./Ys5eufZ_.js";import{u as y}from"./whLkva8r.js";const f=()=>{const{$supabase:s}=d(),{employee:i}=y(),n=r=>(console.error("API Error:",r),{success:!1,error:r.message||"An error occurred"}),u={list:async r=>{try{let t=s.from("incidents").select("*").eq("organization_id",i.value.organization_id).order("created_at",{ascending:!1});r?.status&&(Array.isArray(r.status)?t=t.in("status",r.status):t=t.eq("status",r.status)),r?.priority&&(t=t.eq("priority",r.priority));const{data:e,error:a}=await t;if(a)throw a;return{success:!0,data:e}}catch(t){return n(t)}},get:async r=>{try{const{data:t,error:e}=await s.from("incidents").select("*").eq("id",r).single();if(e)throw e;return{success:!0,data:t}}catch(t){return n(t)}},create:async r=>{try{const{data:t,error:e}=await s.from("incidents").insert({...r,organization_id:i.value.organization_id,created_by:i.value.id,incident_number:`INC-${Date.now()}`,dispatch_time:new Date().toISOString()}).select().single();if(e)throw e;return await s.from("incident_timeline").insert({incident_id:t.id,event_type:"Incident Created",created_by:i.value.id}),{success:!0,data:t}}catch(t){return n(t)}},update:async(r,t)=>{try{const{data:e,error:a}=await s.from("incidents").update(t).eq("id",r).select().single();if(a)throw a;return{success:!0,data:e}}catch(e){return n(e)}}},c={list:async r=>{try{let t=s.from("units").select("*, unit_type:unit_types(*)").eq("organization_id",i.value.organization_id);r?.status&&(t=t.eq("status",r.status)),r?.is_active!==void 0&&(t=t.eq("is_active",r.is_active));const{data:e,error:a}=await t;if(a)throw a;return{success:!0,data:e}}catch(t){return n(t)}},updateStatus:async(r,t)=>{try{const{data:e,error:a}=await s.from("units").update({status:t,updated_at:new Date().toISOString()}).eq("id",r).select().single();if(a)throw a;return await s.from("unit_status_history").insert({unit_id:r,status:t,updated_by:i.value.id}),{success:!0,data:e}}catch(e){return n(e)}}};return{incidents:u,units:c,dispatches:{create:async(r,t)=>{try{const{data:e,error:a}=await s.from("dispatches").insert({incident_id:r,unit_id:t,assigned_by:i.value.id,status:"assigned"}).select().single();if(a)throw a;return await c.updateStatus(t,"dispatched"),await s.from("incident_timeline").insert({incident_id:r,event_type:"Unit Dispatched",created_by:i.value.id}),{success:!0,data:e}}catch(e){return n(e)}},updateStatus:async(r,t)=>{try{const e={status:t};t==="acknowledged"&&(e.acknowledged_at=new Date().toISOString()),t==="enroute"&&(e.enroute_at=new Date().toISOString()),t==="on_scene"&&(e.on_scene_at=new Date().toISOString()),t==="cleared"&&(e.cleared_at=new Date().toISOString());const{data:a,error:o}=await s.from("dispatches").update(e).eq("id",r).select("*, incident:incidents(*)").single();if(o)throw o;return{success:!0,data:a}}catch(e){return n(e)}}},patientRecords:{list:async r=>{try{let t=s.from("patient_records").select("*, incident:incidents(*), transport:transports(*)").eq("organization_id",i.value.organization_id).order("created_at",{ascending:!1});r?.status&&(t=t.eq("status",r.status));const{data:e,error:a}=await t;if(a)throw a;return{success:!0,data:e}}catch(t){return n(t)}},get:async r=>{try{const{data:t,error:e}=await s.from("patient_records").select("*, incident:incidents(*), transport:transports(*), destination:destinations(*)").eq("id",r).single();if(e)throw e;return{success:!0,data:t}}catch(t){return n(t)}},create:async r=>{try{const{data:t,error:e}=await s.from("patient_records").insert({...r,organization_id:i.value.organization_id,record_number:`PCR-${Date.now()}`,completed_by:i.value.id}).select().single();if(e)throw e;return{success:!0,data:t}}catch(t){return n(t)}},update:async(r,t)=>{try{const{data:e,error:a}=await s.from("patient_records").update(t).eq("id",r).select().single();if(a)throw a;return{success:!0,data:e}}catch(e){return n(e)}}},transports:{list:async r=>{try{let t=s.from("transports").select("*, unit:units(*), destination:destinations(*), incident:incidents(*)").order("requested_at",{ascending:!1});r?.status&&(Array.isArray(r.status)?t=t.in("status",r.status):t=t.eq("status",r.status));const{data:e,error:a}=await t;if(a)throw a;return{success:!0,data:e}}catch(t){return n(t)}},create:async r=>{try{const{data:t,error:e}=await s.from("transports").insert({...r,requested_by:i.value.id,status:"requested"}).select().single();if(e)throw e;return{success:!0,data:t}}catch(t){return n(t)}}}}};export{f as u};
