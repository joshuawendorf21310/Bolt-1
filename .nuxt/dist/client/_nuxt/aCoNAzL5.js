const A=()=>{const n=useSupabaseClient(),r=5e4,p=4500;return{MONTHLY_PLATFORM_FEE:r,PER_CALL_FEE:p,createAgencySubscription:async(e,t,a=1)=>{const i=new Date,l=new Date(i.getFullYear(),i.getMonth(),a),s=new Date(i.getFullYear(),i.getMonth()+1,a),{data:_,error:u}=await n.from("agency_subscriptions").insert({agency_id:e,agency_name:t,subscription_status:"active",monthly_platform_fee:r,billing_cycle_day:a,current_period_start:l.toISOString().split("T")[0],current_period_end:s.toISOString().split("T")[0]}).select().single();if(u)throw u;return _},recordBillableCall:async e=>{const{data:t}=await n.from("billable_calls").select("id").eq("encounter_id",e.encounterId).maybeSingle();if(t)return t;const{data:a,error:i}=await n.from("billable_calls").insert({agency_id:e.agencyId,call_type:e.callType,encounter_id:e.encounterId,encounter_number:e.encounterNumber,call_date:e.callDate,per_call_fee:p,billing_status:"pending"}).select().single();if(i)throw i;return a},generateMonthlyInvoice:async(e,t,a)=>{const{data:i}=await n.from("agency_subscriptions").select("*").eq("agency_id",e).maybeSingle();if(!i)throw new Error("No active subscription found");const{data:l}=await n.from("billable_calls").select("*").eq("agency_id",e).eq("billing_status","pending").gte("call_date",t).lte("call_date",a),s=l?.length||0,_=s*p,u=r+_,g=`PLAT-${Date.now()}-${e.substring(0,8)}`,m=new Date(a);m.setDate(m.getDate()+15);const{data:d,error:b}=await n.from("platform_invoices").insert({agency_id:e,invoice_number:g,invoice_period_start:t,invoice_period_end:a,base_platform_fee:r,billable_calls_count:s,billable_calls_total:_,subtotal:u,total_amount_due:u,invoice_status:"draft",due_date:m.toISOString().split("T")[0]}).select().single();if(b)throw b;return await n.from("platform_invoice_line_items").insert([{invoice_id:d.id,line_type:"base_fee",description:"Monthly Platform Fee",quantity:1,unit_price:r,amount:r,period_start:t,period_end:a},{invoice_id:d.id,line_type:"per_call_fee",description:`Billable Calls (${s} calls @ $45.00 each)`,quantity:s,unit_price:p,amount:_,period_start:t,period_end:a}]),l&&l.length>0&&await n.from("billable_calls").update({billing_status:"invoiced",invoiced_at:new Date().toISOString(),platform_invoice_id:d.id}).in("id",l.map(f=>f.id)),d},sendInvoice:async e=>{const{error:t}=await n.from("platform_invoices").update({invoice_status:"sent",issued_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",e);if(t)throw t},markInvoicePaid:async e=>{const{data:t}=await n.from("platform_invoices").select("*").eq("id",e).maybeSingle();if(!t)throw new Error("Invoice not found");const{error:a}=await n.from("platform_invoices").update({invoice_status:"paid",amount_paid:t.total_amount_due,paid_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",e);if(a)throw a;await n.from("billable_calls").update({billing_status:"paid"}).eq("platform_invoice_id",e)},getAgencyInvoices:async e=>{const{data:t,error:a}=await n.from("platform_invoices").select("*").eq("agency_id",e).order("invoice_period_start",{ascending:!1});if(a)throw a;return t||[]},getInvoiceDetails:async e=>{const{data:t}=await n.from("platform_invoices").select("*").eq("id",e).maybeSingle(),{data:a}=await n.from("platform_invoice_line_items").select("*").eq("invoice_id",e).order("line_type");return{invoice:t,lineItems:a||[]}},getPlatformRevenueAnalytics:async()=>{const{data:e}=await n.from("platform_invoices").select("*"),t=e?.reduce((o,c)=>o+Number(c.amount_paid),0)||0,a=e?.reduce((o,c)=>o+Number(c.base_platform_fee),0)||0,i=e?.reduce((o,c)=>o+Number(c.billable_calls_total),0)||0,l=e?.filter(o=>o.invoice_status==="paid")||[],s=e?.filter(o=>o.invoice_status==="overdue")||[],_=e?.reduce((o,c)=>o+(Number(c.total_amount_due)-Number(c.amount_paid)),0)||0,{data:u}=await n.from("agency_subscriptions").select("*").eq("subscription_status","active"),g=u?.length||0,m=g*r,{data:d}=await n.from("billable_calls").select("*"),b=d?.length||0,f=d?.filter(o=>o.billing_status==="paid").length||0;return{totalRevenue:t,recurringRevenue:a,usageRevenue:i,monthlyRecurringRevenue:m,outstandingAmount:_,activeSubscriptions:g,totalInvoices:e?.length||0,paidInvoices:l.length,overdueInvoices:s.length,totalBillableCalls:b,paidCalls:f,averageCallsPerAgency:g>0?b/g:0}},getBillableCallsByPeriod:async(e,t,a)=>{const{data:i,error:l}=await n.from("billable_calls").select("*").eq("agency_id",e).gte("call_date",t).lte("call_date",a).order("call_date",{ascending:!1});if(l)throw l;return i||[]}}};export{A as u};
