{"file":"usePlatformPricing-DwP11hj2.js","mappings":"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","names":[],"sources":["../../../../composables/usePlatformPricing.ts"],"sourcesContent":["export const usePlatformPricing = () => {\n  const supabase = useSupabaseClient()\n\n  const MONTHLY_PLATFORM_FEE = 50000\n  const PER_CALL_FEE = 4500\n\n  const createAgencySubscription = async (agencyId: string, agencyName: string, billingCycleDay: number = 1) => {\n    const today = new Date()\n    const currentPeriodStart = new Date(today.getFullYear(), today.getMonth(), billingCycleDay)\n    const currentPeriodEnd = new Date(today.getFullYear(), today.getMonth() + 1, billingCycleDay)\n\n    const { data, error } = await supabase\n      .from('agency_subscriptions')\n      .insert({\n        agency_id: agencyId,\n        agency_name: agencyName,\n        subscription_status: 'active',\n        monthly_platform_fee: MONTHLY_PLATFORM_FEE,\n        billing_cycle_day: billingCycleDay,\n        current_period_start: currentPeriodStart.toISOString().split('T')[0],\n        current_period_end: currentPeriodEnd.toISOString().split('T')[0]\n      })\n      .select()\n      .single()\n\n    if (error) throw error\n    return data\n  }\n\n  const recordBillableCall = async (data: {\n    agencyId: string\n    callType: 'ems_transport' | 'treatment_in_place' | 'refusal' | 'private_pay' | 'telehealth'\n    encounterId: string\n    encounterNumber: string\n    callDate: string\n  }) => {\n    const { data: existing } = await supabase\n      .from('billable_calls')\n      .select('id')\n      .eq('encounter_id', data.encounterId)\n      .maybeSingle()\n\n    if (existing) {\n      return existing\n    }\n\n    const { data: billableCall, error } = await supabase\n      .from('billable_calls')\n      .insert({\n        agency_id: data.agencyId,\n        call_type: data.callType,\n        encounter_id: data.encounterId,\n        encounter_number: data.encounterNumber,\n        call_date: data.callDate,\n        per_call_fee: PER_CALL_FEE,\n        billing_status: 'pending'\n      })\n      .select()\n      .single()\n\n    if (error) throw error\n    return billableCall\n  }\n\n  const generateMonthlyInvoice = async (agencyId: string, periodStart: string, periodEnd: string) => {\n    const { data: subscription } = await supabase\n      .from('agency_subscriptions')\n      .select('*')\n      .eq('agency_id', agencyId)\n      .maybeSingle()\n\n    if (!subscription) throw new Error('No active subscription found')\n\n    const { data: unbilledCalls } = await supabase\n      .from('billable_calls')\n      .select('*')\n      .eq('agency_id', agencyId)\n      .eq('billing_status', 'pending')\n      .gte('call_date', periodStart)\n      .lte('call_date', periodEnd)\n\n    const callsCount = unbilledCalls?.length || 0\n    const callsTotal = callsCount * PER_CALL_FEE\n    const subtotal = MONTHLY_PLATFORM_FEE + callsTotal\n\n    const invoiceNumber = `PLAT-${Date.now()}-${agencyId.substring(0, 8)}`\n    const dueDate = new Date(periodEnd)\n    dueDate.setDate(dueDate.getDate() + 15)\n\n    const { data: invoice, error } = await supabase\n      .from('platform_invoices')\n      .insert({\n        agency_id: agencyId,\n        invoice_number: invoiceNumber,\n        invoice_period_start: periodStart,\n        invoice_period_end: periodEnd,\n        base_platform_fee: MONTHLY_PLATFORM_FEE,\n        billable_calls_count: callsCount,\n        billable_calls_total: callsTotal,\n        subtotal: subtotal,\n        total_amount_due: subtotal,\n        invoice_status: 'draft',\n        due_date: dueDate.toISOString().split('T')[0]\n      })\n      .select()\n      .single()\n\n    if (error) throw error\n\n    await supabase\n      .from('platform_invoice_line_items')\n      .insert([\n        {\n          invoice_id: invoice.id,\n          line_type: 'base_fee',\n          description: 'Monthly Platform Fee',\n          quantity: 1,\n          unit_price: MONTHLY_PLATFORM_FEE,\n          amount: MONTHLY_PLATFORM_FEE,\n          period_start: periodStart,\n          period_end: periodEnd\n        },\n        {\n          invoice_id: invoice.id,\n          line_type: 'per_call_fee',\n          description: `Billable Calls (${callsCount} calls @ $45.00 each)`,\n          quantity: callsCount,\n          unit_price: PER_CALL_FEE,\n          amount: callsTotal,\n          period_start: periodStart,\n          period_end: periodEnd\n        }\n      ])\n\n    if (unbilledCalls && unbilledCalls.length > 0) {\n      await supabase\n        .from('billable_calls')\n        .update({\n          billing_status: 'invoiced',\n          invoiced_at: new Date().toISOString(),\n          platform_invoice_id: invoice.id\n        })\n        .in('id', unbilledCalls.map(call => call.id))\n    }\n\n    return invoice\n  }\n\n  const sendInvoice = async (invoiceId: string) => {\n    const { error } = await supabase\n      .from('platform_invoices')\n      .update({\n        invoice_status: 'sent',\n        issued_at: new Date().toISOString(),\n        updated_at: new Date().toISOString()\n      })\n      .eq('id', invoiceId)\n\n    if (error) throw error\n  }\n\n  const markInvoicePaid = async (invoiceId: string) => {\n    const { data: invoice } = await supabase\n      .from('platform_invoices')\n      .select('*')\n      .eq('id', invoiceId)\n      .maybeSingle()\n\n    if (!invoice) throw new Error('Invoice not found')\n\n    const { error } = await supabase\n      .from('platform_invoices')\n      .update({\n        invoice_status: 'paid',\n        amount_paid: invoice.total_amount_due,\n        paid_at: new Date().toISOString(),\n        updated_at: new Date().toISOString()\n      })\n      .eq('id', invoiceId)\n\n    if (error) throw error\n\n    await supabase\n      .from('billable_calls')\n      .update({ billing_status: 'paid' })\n      .eq('platform_invoice_id', invoiceId)\n  }\n\n  const getAgencyInvoices = async (agencyId: string) => {\n    const { data, error } = await supabase\n      .from('platform_invoices')\n      .select('*')\n      .eq('agency_id', agencyId)\n      .order('invoice_period_start', { ascending: false })\n\n    if (error) throw error\n    return data || []\n  }\n\n  const getInvoiceDetails = async (invoiceId: string) => {\n    const { data: invoice } = await supabase\n      .from('platform_invoices')\n      .select('*')\n      .eq('id', invoiceId)\n      .maybeSingle()\n\n    const { data: lineItems } = await supabase\n      .from('platform_invoice_line_items')\n      .select('*')\n      .eq('invoice_id', invoiceId)\n      .order('line_type')\n\n    return {\n      invoice,\n      lineItems: lineItems || []\n    }\n  }\n\n  const getPlatformRevenueAnalytics = async () => {\n    const { data: invoices } = await supabase\n      .from('platform_invoices')\n      .select('*')\n\n    const totalRevenue = invoices?.reduce((sum, inv) => sum + Number(inv.amount_paid), 0) || 0\n    const recurringRevenue = invoices?.reduce((sum, inv) => sum + Number(inv.base_platform_fee), 0) || 0\n    const usageRevenue = invoices?.reduce((sum, inv) => sum + Number(inv.billable_calls_total), 0) || 0\n\n    const paidInvoices = invoices?.filter(inv => inv.invoice_status === 'paid') || []\n    const overdueInvoices = invoices?.filter(inv => inv.invoice_status === 'overdue') || []\n    const outstandingAmount = invoices?.reduce((sum, inv) =>\n      sum + (Number(inv.total_amount_due) - Number(inv.amount_paid)), 0\n    ) || 0\n\n    const { data: subscriptions } = await supabase\n      .from('agency_subscriptions')\n      .select('*')\n      .eq('subscription_status', 'active')\n\n    const activeSubscriptions = subscriptions?.length || 0\n    const monthlyRecurringRevenue = activeSubscriptions * MONTHLY_PLATFORM_FEE\n\n    const { data: calls } = await supabase\n      .from('billable_calls')\n      .select('*')\n\n    const totalBillableCalls = calls?.length || 0\n    const paidCalls = calls?.filter(c => c.billing_status === 'paid').length || 0\n\n    return {\n      totalRevenue,\n      recurringRevenue,\n      usageRevenue,\n      monthlyRecurringRevenue,\n      outstandingAmount,\n      activeSubscriptions,\n      totalInvoices: invoices?.length || 0,\n      paidInvoices: paidInvoices.length,\n      overdueInvoices: overdueInvoices.length,\n      totalBillableCalls,\n      paidCalls,\n      averageCallsPerAgency: activeSubscriptions > 0 ? totalBillableCalls / activeSubscriptions : 0\n    }\n  }\n\n  const getBillableCallsByPeriod = async (agencyId: string, startDate: string, endDate: string) => {\n    const { data, error } = await supabase\n      .from('billable_calls')\n      .select('*')\n      .eq('agency_id', agencyId)\n      .gte('call_date', startDate)\n      .lte('call_date', endDate)\n      .order('call_date', { ascending: false })\n\n    if (error) throw error\n    return data || []\n  }\n\n  return {\n    MONTHLY_PLATFORM_FEE,\n    PER_CALL_FEE,\n    createAgencySubscription,\n    recordBillableCall,\n    generateMonthlyInvoice,\n    sendInvoice,\n    markInvoicePaid,\n    getAgencyInvoices,\n    getInvoiceDetails,\n    getPlatformRevenueAnalytics,\n    getBillableCallsByPeriod\n  }\n}\n"],"version":3}